---
title: "psycopg2ã§ã‚¹ã‚­ãƒ¼ãƒã‚’æŒ‡å®šã—ã¦COPYã™ã‚‹æ–¹æ³•"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "PostgreSQL", "psycopg2"]
published: false
---

# è¦ç´„
æ¥­å‹™ä¸­ã«ç™ºç”Ÿã—ãŸä¸å…·åˆã‚’è¨˜äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚è©³ç´°ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚
* PostgreSQLã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’COPYã™ã‚‹éš›ã€ã‚¹ã‚­ãƒ¼ãƒæŒ‡å®šãŒã§ããªã„ä¸å…·åˆãŒç™ºç”Ÿ
* åŸå› ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ›´æ–°ã§ã€psycopg2 2.9ä»¥é™ã§ã¯`copy_from`é–¢æ•°ã§ã‚¹ã‚­ãƒ¼ãƒã‚’æŒ‡å®šå‡ºæ¥ãªããªã£ãŸç‚º
* ä¸Šè¨˜ã®äº‹è±¡ã«å¯¾ã—ã¦ã€ã‚¹ã‚­ãƒ¼ãƒæ¤œç´¢ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦è§£æ±ºã—ãŸ

ä»Šå›ã¯ã€ä¸å…·åˆã‚’å†ç¾ã™ã‚‹æ‰€ã‹ã‚‰å§‹ã‚ã€å•é¡Œã®è§£æ±ºãƒ•ãƒ­ãƒ¼ã‚’ãªã‚‹ã¹ãç´°ã‹ãè¨˜äº‹ã«ã—ã¦ã¿ã¾ã™ï¼

# æ¤œè¨¼ç’°å¢ƒãƒ»ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
* Windows10 x86-64
* Python 3.11.3
* PostgreSQL 16.1 
* psycopg2 2.9.9
* psycopg2 2.8.6ï¼ˆæ—§verã®æ¯”è¼ƒç”¨ï¼‰

# æ¤œè¨¼DBãƒ»ãƒ‡ãƒ¼ã‚¿
æ¤œè¨¼ç›®çš„ã§ç°¡å˜ãªDBãƒ»å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
ã‚¹ã‚­ãƒ¼ãƒã‚’æŒ‡å®šã§ãã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã€ç•°ãªã‚‹ã‚¹ã‚­ãƒ¼ãƒåã§åŒã˜åå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

## DBæ§‹æˆ
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼šcopy_test
ã‚¹ã‚­ãƒ¼ãƒï¼špublic, sub_schema
ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šusersï¼ˆä¸‹å›³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’2ã¤ã®ã‚¹ã‚­ãƒ¼ãƒã«ä½œæˆï¼‰

![alt text](/images/users_table.png)

## å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
usersãƒ†ãƒ¼ãƒ–ãƒ«ã¨åŒã˜æ§‹é€ ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
```csv
name,email
Azusa Nakano,azusa11@example.com
Megumi Kitamura,megumi@example.com
Naoe Riki,naoenaoe@example.com
Satoshi Akatsuka,s4toshi@example.com
```

# `copy_from`é–¢æ•°ã®å‹•ä½œç¢ºèª
ã¾ãšã¯ä¸å…·åˆã‚’ç¢ºèªã™ã‚‹å‰ã«ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å‹•ä½œæ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
psycopg2ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯2.8.6ã‚’åˆ©ç”¨ã—ã€ã‚¹ã‚­ãƒ¼ãƒæŒ‡å®šã—ã¦`copy_from`é–¢æ•°ãŒå‹•ä½œã™ã‚‹ã‹è©¦ã—ã¾ã™ã€‚
éå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚
`pip install psycopg2==2.8.6`

ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã§`sub_schema.users`ã«ãƒ‡ãƒ¼ã‚¿ã‚’COPYã—ã¾ã™ã€‚
```python
import psycopg2

def main():
    """psycopg2 2.8.6ã§COPYã®å‹•ä½œã‚’ç¢ºèª
    """
    schema = "test"
    table_name = "t_user"
    import_file = "user_list.csv"
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.copy_from(file=import_file, table=f"{schema}.{table_name}", sep=",")

def get_connection():
    dsn = {
        "host":"localhost",
        "port":"5432",
        "database":"test_db",
        "user":"postgres",
        "password":"postgres",
    }
    return psycopg2.connect(**dsn)

if __name__ == "__main__":
    main()
```


# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®å‹•ä½œæ¤œè¨¼
```python
cursor.copy_from(file=f, table="schema.table_name", sep=",")
# >>> UndefinedTable: relation "schema.table" does not exist
```

# è§£æ±ºç­–
```python
cursor.execute(f'SET search_path TO {schema}')
```

# å‚è€ƒ
cursor.copy_from table argument no longer accepting schema #1294
https://github.com/psycopg/psycopg2/issues/1294

ã‚¹ã‚­ãƒ¼ãƒæ¤œç´¢ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹
https://www.javadrive.jp/postgresql/schema/index4.html
