---
title: "psycopg2„Åß„Çπ„Ç≠„Éº„Éû„ÇíÊåáÂÆö„Åó„Å¶COPY„Åô„ÇãÊñπÊ≥ï"
emoji: "üç£"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["Python", "PostgreSQL", "psycopg2"]
published: true
---

# Ë¶ÅÁ¥Ñ
Ê•≠Âãô‰∏≠„Å´Âèñ„ÇäÁµÑ„Çì„Å†‰∏çÂÖ∑ÂêàËß£Ê±∫„ÅÆ„Éï„É≠„Éº„ÇíË®ò‰∫ã„Å´„Åó„Å¶„Åø„Åæ„Åó„Åü„ÄÇ
Ë©≥Á¥∞„ÅØ‰∏ãË®ò„ÅÆ„Å®„Åä„Çä„Åß„Åô„ÄÇ
* PostgreSQL„Å´CSV„Éï„Ç°„Ç§„É´„ÇíCOPY„Åô„ÇãÈöõ„ÄÅ„Çπ„Ç≠„Éº„ÉûÊåáÂÆö„Åå„Åß„Åç„Å™„ÅÑ‰∏çÂÖ∑Âêà„ÅåÁô∫Áîü
* ÂéüÂõ†„ÅØ„É©„Ç§„Éñ„É©„É™„ÅÆÊõ¥Êñ∞„Åß„ÄÅpsycopg2 2.9‰ª•Èôç„Åß„ÅØ`copy_from`Èñ¢Êï∞„Åß„Çπ„Ç≠„Éº„Éû„ÇíÊåáÂÆöÂá∫Êù•„Å™„Åè„Å™„Å£„ÅüÁÇ∫
* ‰∏äË®ò„ÅÆ‰∫ãË±°„Å´ÂØæ„Åó„Å¶„ÄÅ„Çπ„Ç≠„Éº„ÉûÊ§úÁ¥¢„Éë„Çπ„ÇíË®≠ÂÆö„Åó„Å¶Ëß£Ê±∫„Åó„Åü

‰ªäÂõû„ÅØ„ÄÅ‰∏çÂÖ∑Âêà„ÇíÂÜçÁèæ„Åô„ÇãÊâÄ„Åã„ÇâÂßã„ÇÅ„ÄÅÂïèÈ°å„ÅÆËß£Ê±∫„Éï„É≠„Éº„Çí„Å™„Çã„Åπ„ÅèÁ¥∞„Åã„ÅèË®ò‰∫ã„Å´„Åó„Å¶„Åø„Åæ„ÅôÔºÅ

## Ê§úË®ºÊâãÈ†Ü
1. COPY„ÅÆÂãï‰Ωú„ÇíÊ§úË®º„Åô„ÇãDB„ÉªÂÖ•Âäõ„Éá„Éº„Çø„ÇíÁî®ÊÑè
2. Âè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆpsycopg2„Åß„ÄÅ`copy_from`„É°„ÇΩ„ÉÉ„Éâ„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
3. Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆpsycopg2„Åß„ÄÅÂêåÊßò„ÅÆ„Ç≥„Éº„Éâ„ÅåÂãï„Åã„Å™„ÅÑ‰∏çÂÖ∑Âêà„ÇíÁ¢∫Ë™ç
4. „Çπ„Ç≠„Éº„ÉûÊ§úÁ¥¢„Éë„Çπ„ÇíÊåáÂÆö„Åó„Å¶‰∏äË®òÂïèÈ°å„ÇíËß£Ê±∫„Åô„Çã

# Ê§úË®ºÁí∞Â¢É
## OS„Éª„ÇΩ„Éï„Éà„Ç¶„Çß„Ç¢
* Windows10 x86-64
* PostgreSQL 16.1
* Python 3.8.10
* Python 3.10.5
* psycopg2 2.9.9
* psycopg2 2.8.6
* pyenv 3.1.1

## „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÊàê
Ê§úË®ºÁõÆÁöÑ„ÅßÁ∞°Âçò„Å™DB„ÇíÁî®ÊÑè„Åó„Åæ„Åó„Åü„ÄÇ
„Çπ„Ç≠„Éº„Éû„ÇíÊåáÂÆö„Åß„Åç„Çã„ÅãÁ¢∫Ë™ç„Åô„Çã„Åü„ÇÅ„ÄÅÁï∞„Å™„Çã„Çπ„Ç≠„Éº„ÉûÂêç„ÅßÂêå„ÅòÂêçÂâç„ÅÆ„ÉÜ„Éº„Éñ„É´„Çí‰ΩúÊàê„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

„Éá„Éº„Çø„Éô„Éº„ÇπÔºöcopy_test
„Çπ„Ç≠„Éº„ÉûÔºöpublic, sub_schema
„ÉÜ„Éº„Éñ„É´ÔºöusersÔºà‰∏ãÂõ≥„ÅÆ„ÉÜ„Éº„Éñ„É´„Çí2„Å§„ÅÆ„Çπ„Ç≠„Éº„Éû„Å´‰ΩúÊàêÔºâ

![alt text](/images/users_table.png)

## ÂÖ•Âäõ„Éá„Éº„Çø
users„ÉÜ„Éº„Éñ„É´„Å®Âêå„ÅòÊßãÈÄ†„ÅÆCSV„Éï„Ç°„Ç§„É´„ÇíÁî®ÊÑè„Åó„Åæ„Åó„Åü„ÄÇ
„É¶„Éº„Ç∂„ÉºÂêç„Å®„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆ„Åø„ÅÆ„Ç∑„É≥„Éó„É´„Å™ÂÖ•Âäõ„Éï„Ç°„Ç§„É´„Åß„Åô„ÄÇ
```csv
Azusa Nakano,azusa11@example.com
Megumi Kitamura,megumi@example.com
Naoe Riki,naoenaoe@example.com
Satoshi Akatsuka,s4toshi@example.com
```

# Âè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åß`copy_from`„É°„ÇΩ„ÉÉ„Éâ„ÅÆÂãï‰ΩúÁ¢∫Ë™ç
„Åæ„Åö„ÅØ„ÄÅÂè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„É©„Ç§„Éñ„É©„É™„Åß„Çπ„Ç≠„Éº„Éû„ÇíÊåáÂÆö„Åó„ÅüCOPY„Åå„Åß„Åç„Çã„ÅãÂãï‰ΩúÊ§úË®º„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ
Python„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅØ3.8.10„ÄÅpsycopg2„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅØ2.8.6„ÇíÂà©Áî®„Åó„Åæ„Åó„Åü„ÄÇ
‰∏ãË®ò„Ç≥„Éº„Éâ„Åß`sub_schema.users`„Å´„Éá„Éº„Çø„ÇíCOPY„Åó„Åæ„Åô„ÄÇ
```python
import psycopg2

def main():
    """psycopg2 2.8.6„ÅßCOPY„ÅÆÂãï‰Ωú„ÇíÁ¢∫Ë™ç
    """
    schema = "sub_schema"
    table_name = "users"
    with get_connection() as conn:
        with conn.cursor() as cur:
            with open(r"input_file\user_list.csv", mode="r", encoding="utf-8") as f:
                cur.copy_from(f, table=f"{schema}.{table_name}", sep=",", columns=('name', 'email'))
                conn.commit()

def get_connection():
    dsn = {
        "host":"localhost",
        "port":"5432",
        "database":"copy_test",
        "user":"postgres",
        "password":"postgres",
    }
    return psycopg2.connect(**dsn)

if __name__ == "__main__":
    main()
```
„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÇíÂÆüË°å„Åó„ÄÅÁÑ°‰∫ã„Å´COPY„Åï„Çå„Åü‰∫ã„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü„ÄÇ
![alt text](/images/select_users.png)

# Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åß`copy_from`„É°„ÇΩ„ÉÉ„Éâ„ÅÆÂãï‰ΩúÁ¢∫Ë™ç
Ê¨°„Å´„ÄÅÊñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„É©„Ç§„Éñ„É©„É™„Åß„Çπ„Ç≠„Éº„Éû„ÇíÊåáÂÆö„Åó„ÅüCOPY„Åå„Åß„Åç„Çã„ÅãÂãï‰ΩúÊ§úË®º„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ
Python„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅØ3.10.5„ÄÅpsycopg2„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅØ2.9.9„ÇíÂà©Áî®„Åó„Åæ„Åó„Åü„ÄÇ
Âêå„Åò„Ç≥„Éº„Éâ„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„Åå„ÄÅ‰∏ãË®ò„ÅÆ„Çà„ÅÜ„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åô„ÄÇ
```powershell
PS C:\git\copy-test> & c:/git/copy-test/venv/Scripts/python.exe c:/git/copy-test/venv/copy_test.py
Traceback (most recent call last):
  File "c:\git\copy-test\venv\copy_test.py", line 25, in <module>
    main()
  File "c:\git\copy-test\venv\copy_test.py", line 11, in main
    cur.copy_from(f, table=f"{schema}.{table_name}", sep=",", columns=('name', 'email'))
psycopg2.errors.UndefinedTable: „É™„É¨„Éº„Ç∑„Éß„É≥"sub_schema.users"„ÅØÂ≠òÂú®„Åó„Åæ„Åõ„Çì
```
**psycopg2.errors.UndefinedTable: „É™„É¨„Éº„Ç∑„Éß„É≥"sub_schema.users"„ÅØÂ≠òÂú®„Åó„Åæ„Åõ„Çì**
...„Å®Ë®òËºâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„Çπ„Ç≠„Éº„Éû„ÅØÂÆüÈöõ„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ
Âàù„ÇÅ„Å¶„Åì„ÅÆ„Ç®„É©„Éº„Å´ÂΩì„Åü„Å£„Åü„Å®„Åç„ÅØÊ∑∑‰π±„Åó„Åæ„Åó„Åü„ÄÇ„ÄÇ

# Ëß£Ê±∫Á≠ñ
DBÂÅ¥„ÇíË™øÊüª„Åó„Å¶„ÇÇËß£Ê±∫„Åõ„Åö„ÄÅgoogleÊ§úÁ¥¢„Åó„Åü„Å®„Åì„Çç„ÄÅ„ÅÇ„Åæ„ÇäËâØ„ÅÑÊÉÖÂ†±„Å´„Åü„Å©„ÇäÁùÄ„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ
„Åù„Åì„Åß„ÄÅpsycopg2„ÅÆGithub„Åß„Ç®„É©„Éº„ÇíÊ§úÁ¥¢„Åô„Çã„Å®„ÄÅ‰∏ãË®òIssue„Åå„Éí„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ
https://github.com/psycopg/psycopg2/issues/1294

cursor.copy_from„É°„ÇΩ„ÉÉ„Éâ„Åå„ÉÜ„Éº„Éñ„É´ÂºïÊï∞„Åß„Çπ„Ç≠„Éº„Éû„ÇíÂèó„Åë‰ªò„Åë„Å™„Åè„Å™„Å£„Åü„ÄÇ„Å®„ÅÆ„Åì„Å®„Åß„ÄÅÂêå„Åò‰∫ãË±°„Å´„Å§„ÅÑ„Å¶„ÅÆ„Çπ„É¨„ÉÉ„Éâ„Åã„ÇâËß£Ê±∫Á≠ñ„ÇíÊé¢„Åó„Åæ„Åó„Åü„ÄÇ
„Çπ„É¨„ÉÉ„ÉâÂÜÖ„Åß„ÅØ„Äå„Çπ„Ç≠„Éº„ÉûÊ§úÁ¥¢„Éë„Çπ„ÇíÊåáÂÆö„Åô„Çã„Äç„Å®„ÅÑ„ÅÜÊñπÊ≥ï„ÅßÂõûÈÅø„Åô„ÇãÊñπÊ≥ï„ÅåÁ¥π‰ªã„Åï„Çå„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ
ÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„ÄÅ‰∏ãË®ò„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åô„ÇãÊñπÊ≥ï„Åß„Åô„ÄÇ
```python
cursor.execute(f'SET search_path TO {schema}')
```
‰∏äË®ò„Ç≥„Éº„Éâ„ÇíËøΩË®ò„Åó„Å¶„ÄÅ„ÉÜ„Éº„Éñ„É´„Åã„Çâ„Çπ„Ç≠„Éº„ÉûÊåáÂÆö„ÇíÂ§ñ„Åô„Åì„Å®„Åß„ÄÅÁÑ°‰∫ã„Å´COPY„ÅåÂÆüË°å„Åß„Åç„Åæ„Åó„Åü„ÄÇ

# „Åæ„Å®„ÇÅ
ÂïèÈ°åËß£Ê±∫„ÅÆ„Éï„É≠„Éº„Åã„ÇâÂ≠¶„Çì„Å†„Åì„Å®„ÇíÁ∞°Âçò„Å´„Åæ„Å®„ÇÅ„Åæ„Åô„ÄÇ
* „É©„Ç§„Éñ„É©„É™„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„Éó„Åß‰∏çÂÖ∑Âêà„ÅåÁô∫Áîü„Åó„Å™„ÅÑ„Åã„Åç„Å°„Çì„Å®Á¢∫Ë™ç„Åô„Çã
* „Éû„Ç§„Éä„Éº„Å™„É©„Ç§„Éñ„É©„É™„ÅÆ‰∏çÂÖ∑Âêà„ÅßË©∞„Åæ„Å£„ÅüÊôÇ„ÅØ„ÄÅ‰∏ÄÊ¨°ÊÉÖÂ†±ÔºàGithub„ÅÆIssuesÁ≠âÔºâ„Åã„ÇâË™ø„Åπ„Çã

‰ªäÂõûÊ§úË®º„Å´Âà©Áî®„Åó„Åü„Ç≥„Éº„Éâ„ÅØ‰∏ãË®òGithub„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇË©≥Á¥∞„ÅåË¶ã„Åü„ÅÑÊñπ„ÅØÊòØÈùû„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑÔºÅ
https://github.com/sakats/copy-test


## Ê≥®ÊÑè‰∫ãÈ†Ö
psycopg2ÈñãÁô∫ËÄÖ„Åã„Çâ„ÄÅ„Çπ„Ç≠„Éº„ÉûÊ§úÁ¥¢„Éë„Çπ„ÅÆÊåáÂÆö„Åå„Çª„ÉÉ„Ç∑„Éß„É≥ÂÖ®‰Ωì„Å´ÂΩ±Èüø„Åô„ÇãÂ†¥Âêà„ÇÇ„ÅÇ„Çã„Å®„Ç≥„É°„É≥„Éà„ÅåÊù•„Å¶„ÅÑ„Åæ„Åô„ÄÇ
Ë§áÊï∞„Çª„ÉÉ„Ç∑„Éß„É≥„ÅßÁï∞„Å™„Çã„Çπ„Ç≠„Éº„Éû‰∏¶Ë°å„Åó„Å¶Êâ±„ÅÜ„Ç±„Éº„Çπ„Å´„ÅØ„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇ
> dvarrazzo commented on Nov 6, 2021
I was able to adapt my existing function by adding this line just prior to calling "copy_from":
curs.execute(f'SET search_path TO {schema}')
This affects the whole session. It might be a good solution for you, as well as for a program, but it's not a good solution with a driver because it has global (session-wide) repercussions.

## ÂèÇËÄÉË®ò‰∫ã
COPY-related methods
https://www.psycopg.org/docs/cursor.html

cursor.copy_from table argument no longer accepting schema #1294
https://github.com/psycopg/psycopg2/issues/1294

„Çπ„Ç≠„Éº„ÉûÊ§úÁ¥¢„Éë„Çπ„ÇíË®≠ÂÆö„Åô„Çã
https://www.javadrive.jp/postgresql/schema/index4.html
