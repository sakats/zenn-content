---
title: "psycopg2ã§ã‚¹ã‚­ãƒ¼ãƒã‚’æŒ‡å®šã—ã¦COPYã™ã‚‹æ–¹æ³•"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "PostgreSQL", "psycopg2"]
published: false
---

# è¦ç´„
Pythonã§PostgreSQLã‚’æ“ä½œã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªpsycopg2ã‚’åˆ©ç”¨ã—ãŸã€‚
psycopg2 ver2.9ä»¥é™ã§ã¯ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’DBã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹`copy_from`é–¢æ•°ã§ã‚¹ã‚­ãƒ¼ãƒã‚’æŒ‡å®šå‡ºæ¥ãªããªã£ãŸã€‚
ä¸Šè¨˜ã®äº‹è±¡ã«å¯¾ã—ã¦ã€ã‚¹ã‚­ãƒ¼ãƒæ¤œç´¢ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦è§£æ±ºã—ãŸã€‚

# æ¤œè¨¼ç’°å¢ƒãƒ»ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
* Windows10 x86-64
* Python 3.11.3
* PostgreSQL 16.1 
* psycopg2 2.9.9
* psycopg2 2.8.6(æ¯”è¼ƒç”¨)

# ã‚¹ã‚­ãƒ¼ãƒæŒ‡å®šã—ã¦COPYã™ã‚‹
ã¾ãšã¯psycopg2 2.8.6ã§ã‚¹ã‚­ãƒ¼ãƒæŒ‡å®šã®COPYãŒã§ãã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
éå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚
`pip install psycopg2==2.8.6`

ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã§CSVãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚
```python
import psycopg2

def main():
    """psycopg2 2.8.6ã§COPYã®å‹•ä½œã‚’ç¢ºèª
    """
    schema = "test"
    table_name = "t_user"
    import_file = "user_list.csv"
    with get_connection() as conn:
        with conn.cursor() as cur:
            cur.copy_from(file=import_file, table=f"{schema}.{table_name}", sep=",")

def get_connection():
    dsn = {
        "host":"localhost",
        "port":"5432",
        "database":"test_db",
        "user":"postgres",
        "password":"postgres",
    }
    return psycopg2.connect(**dsn)

if __name__ == "__main__":
    main()
```


# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®å‹•ä½œæ¤œè¨¼
```python
cursor.copy_from(file=f, table="schema.table_name", sep=",")
# >>> UndefinedTable: relation "schema.table" does not exist
```

# è§£æ±ºç­–
```python
cursor.execute(f'SET search_path TO {schema}')
```

# å‚è€ƒ
cursor.copy_from table argument no longer accepting schema #1294
https://github.com/psycopg/psycopg2/issues/1294

ã‚¹ã‚­ãƒ¼ãƒæ¤œç´¢ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹
https://www.javadrive.jp/postgresql/schema/index4.html
